<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Friends - RayMinder</title>
  <link rel="stylesheet" href="style.css">
  <style>
    #friends-list li {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px;
      border-radius: 6px;
      background: #fff;
      margin-bottom: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.04);
    }

    .friend-actions button {
      margin-left: 6px;
      padding: 6px 8px;
      font-size: 0.9em;
      border-radius: 6px;
      border: none;
      cursor: pointer;
    }

    .btn-open { background: #ff9800; color: white; }
    .btn-remind { background: #4caf50; color: white; }

    .menu-btn {
      width: 100%;
      margin-top: 10px;
      padding: 10px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1em;
    }

    .menu-btn:hover {
      background: #0056b3;
    }

    .status-msg {
      margin-top: 8px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Friends</h1>

    <!-- Main Menu -->
    <div id="menu-section">
      <button class="menu-btn" id="btn-show-add">Add Friend</button>
      <button class="menu-btn" id="btn-show-list">Friends List</button>
      <button class="menu-btn" id="btn-back-you">Back to You</button>
    </div>

    <!-- Add Friend Section -->
    <div id="add-friend-section" style="display: none;">
      <h2>Add a Friend</h2>
      <input type="text" id="friend-username" placeholder="Enter friend's username">
      <button id="add-friend-btn">Add Friend</button>
      <div id="friends-status" class="status-msg"></div>
      <button class="menu-btn" id="btn-back-menu-add">Back to Menu</button>
    </div>

    <!-- Friends List Section -->
    <div id="friends-section" style="display: none;">
      <h2>Your Friends</h2>
      <ul id="friends-list"></ul>
      <div id="list-status" class="status-msg"></div>
      <button class="menu-btn" id="btn-back-menu-list">Back to Menu</button> 
    </div>
  </div>

  <script type="module">
    import { bleConnectionInstance } from './BLEConnection.js';
    console.log("friends.js loaded");

    const API_URL = "http://localhost:5007/api/friends";
    const username = localStorage.getItem("username");

    // Sections
    const addFriendSection = document.getElementById("add-friend-section");
    const friendsSection = document.getElementById("friends-section");
    const menuSection = document.getElementById("menu-section");

    // Elements
    const friendsList = document.getElementById("friends-list");
    const statusMsg = document.getElementById("friends-status");
    const listStatus = document.getElementById("list-status");
    const friendInput = document.getElementById("friend-username");
    const addBtn = document.getElementById("add-friend-btn");

    // Buttons
    const btnShowAdd = document.getElementById("btn-show-add");
    const btnShowList = document.getElementById("btn-show-list");
    const btnBackYou = document.getElementById("btn-back-you");
    const btnBackMenuAdd = document.getElementById("btn-back-menu-add");
    const btnBackMenuList = document.getElementById("btn-back-menu-list");

    // Navigation
    btnShowAdd.addEventListener("click", () => {
      menuSection.style.display = "none";
      friendsSection.style.display = "none";
      addFriendSection.style.display = "block";
    });

    btnShowList.addEventListener("click", async () => {
      menuSection.style.display = "none";
      addFriendSection.style.display = "none";
      friendsSection.style.display = "block";
      await loadFriends();
    });

    btnBackYou.addEventListener("click", () => {
      window.location.href = "you.html";
    });

    btnBackMenuAdd.addEventListener("click", () => {
      addFriendSection.style.display = "none";
      friendsSection.style.display = "none";
      menuSection.style.display = "block";
    });

    btnBackMenuList.addEventListener("click", () => {
      addFriendSection.style.display = "none";
      friendsSection.style.display = "none";
      menuSection.style.display = "block";
    });

    // Helper to show messages
    function showMessage(target, text, color = "black") {
      if (target) {
        target.textContent = text;
        target.style.color = color;
        setTimeout(() => { target.textContent = ""; }, 3000);
      }
    }

    // Load Friends List
    async function loadFriends() {
      try {
        if (!username) {
          showMessage(listStatus, "Not logged in.", "red");
          return;
        }

        const response = await fetch(`${API_URL}/${encodeURIComponent(username)}`);
        if (!response.ok) {
          showMessage(listStatus, "Failed to load friends.", "red");
          return;
        }

        const friends = await response.json();
        friendsList.innerHTML = "";

        if (!friends || friends.length === 0) {
          friendsList.innerHTML = "<li>No friends yet.</li>";
          return;
        }

        friends.forEach(f => {
          const li = document.createElement("li");
          li.innerHTML = `
            <span class="friend-name">${f.friendUsername}</span>
            <span class="friend-actions">
              <button class="btn-open" data-user="${f.friendUsername}">Open</button>
              <button class="btn-remind" data-user="${f.friendUsername}">Remind</button>
            </span>
          `;
          friendsList.appendChild(li);
        });

        // Buttons inside list
        friendsList.querySelectorAll(".btn-open").forEach(btn => {
          btn.addEventListener("click", (e) => {
            const friend = e.currentTarget.dataset.user;
            window.location.href = `friend-dashboard.html?username=${encodeURIComponent(friend)}`;
          });
        });

        friendsList.querySelectorAll(".btn-remind").forEach(btn => {
          btn.addEventListener("click", async (e) => {
            const friend = e.currentTarget.dataset.user;
            showMessage(listStatus, `Sending reminder to ${friend}...`, "orange");
            const res = await sendFriendNotification(friend);
            if (res === null) {
              showMessage(listStatus, `Reminder sent to ${friend}.`, "green");
            } else {
              showMessage(listStatus, `Failed to remind ${friend}.`, "red");
              console.error(res);
            }
          });
        });

      } catch (err) {
        console.error("Error loading friends:", err);
        showMessage(listStatus, "Error loading friends list", "red");
      }
    }

    // Add Friend
    addBtn.addEventListener("click", async () => {
      const friendUsername = friendInput.value.trim();
      if (!friendUsername) {
        showMessage(statusMsg, "Please enter a friend's username.", "red");
        return;
      }

      const data = { username, friendUsername };

      try {
        const response = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data),
        });

        const result = await response.json();

        if (response.ok) {
          showMessage(statusMsg, result.message || "Friend added!", "green");
          friendInput.value = "";
        } else {
          showMessage(statusMsg, result.message || "Failed to add friend.", "red");
        }
      } catch (err) {
        console.error("Error adding friend:", err);
        showMessage(statusMsg, "Server connection error.", "red");
      }
    });

    // Friend Notification 
    async function sendFriendNotification(friendUsername) {
      try {
        const userLocation = await getLocation(username);
        const friendLocation = await getLocation(friendUsername);

        if (!userLocation || !friendLocation) {
          return new Error("Missing location data");
        }

        const rotation = bleConnectionInstance.facingDirection || 0;
        let totalFacingDirection = getBearing(
          userLocation.latitude,
          userLocation.longitude,
          friendLocation.latitude,
          friendLocation.longitude
        );
        totalFacingDirection = (totalFacingDirection + rotation) % 360;

        let buzzer = getDirectionCode(totalFacingDirection);
        let message = String(buzzer);
        await bleConnectionInstance.sendMessage(message);
        return null;
      } catch (err) {
        console.error("Error sending friend notification:", err);
        return err;
      }
    }

    function getDirectionCode(degree) {
      const codes = [5, 2, 6, 3, 7, 0, 4, 1];
      const index = Math.floor(((degree + 22.5) % 360) / 45);
      return codes[index];
    }

    function getBearing(lat1, lon1, lat2, lon2) {
      const toRad = (deg) => (deg * Math.PI) / 180;
      const toDeg = (rad) => (rad * 180) / Math.PI;

      const lat1Rad = toRad(lat1);
      const lat2Rad = toRad(lat2);
      const deltaLonRad = toRad(lon2 - lon1);

      const y = Math.sin(deltaLonRad) * Math.cos(lat2Rad);
      const x = Math.cos(lat1Rad) * Math.sin(lat2Rad) -
                Math.sin(lat1Rad) * Math.cos(lat2Rad) * Math.cos(deltaLonRad);
      const bearingRad = Math.atan2(y, x);
      return (toDeg(bearingRad) + 360) % 360;
    }

    const LOCATION_API_URL = "http://localhost:5007/api/location";
    async function getLocation(user) {
      try {
        const res = await fetch(LOCATION_API_URL + '/' + encodeURIComponent(user));
        if (res.ok) return await res.json();
        return null;
      } catch (err) {
        console.error("getLocation error:", err);
        return null;
      }
    }
  </script>
</body>
</html>
